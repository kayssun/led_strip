#!/usr/bin/env ruby

DEBUG = true

if ARGV[0] && ARGV[0]=='-b'
  case ARGV[1]
  when 'set'
    require 'ws_light/benchmark/set_benchmark'
  when 'animation'
    require 'ws_light/benchmark/animation_benchmark'
  when 'ws2801'
    require 'ws_light/benchmark/ws2801_benchmark'
  else
    puts 'Available benchmarks: set, animation, ws2801'
  end
  exit
end

require 'pi_piper'

include PiPiper

require 'bundler'
require 'ws_light/strip'
require 'ws_light/sd_logger'

PIN_RIGHT = 23
PIN_LEFT = 24

logger = WSLight::SDLogger.new
logger.debug = DEBUG
logger.filename = '/var/log/motion.log'
logger.log 'Starting up'

def unregister_pins
  [PIN_RIGHT, PIN_LEFT].each do |pin|
    File.open('/sys/class/gpio/unexport', 'w') { |f| f.write("#{pin}") }
  end
end

# Trap ^C 
Signal.trap('INT') {
  logger.log 'Shutting down'
  logger.write_log
  unregister_pins
  exit
}
 
# Trap `kill `
Signal.trap('TERM') {
  logger.log 'Shutting down'
  logger.write_log
  unregister_pins
  exit
}

strip = WSLight::Strip.new
strip.debug = DEBUG

after :pin => PIN_RIGHT, :goes => :high do
  logger.log('Motion detected: RIGHT')
  strip.on(:direction_right)
end

after :pin => PIN_LEFT, :goes => :high do
  logger.log('Motion detected: LEFT')
  strip.on(:direction_left)
end

PiPiper.wait
	